<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¼ì„œ ë°ì´í„° ì „ì†¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }

        .status-section {
            margin-bottom: 25px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #007aff;
        }

        .status-label {
            font-weight: 500;
            color: #333;
        }

        .status-value {
            font-weight: 600;
            color: #007aff;
        }

        .status-value.connected {
            color: #28a745;
        }

        .status-value.disconnected {
            color: #dc3545;
        }

        .sensor-data {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sensor-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .sensor-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .sensor-value {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sensor-value-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .sensor-value-number {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .permission-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .permission-text {
            color: #856404;
            text-align: center;
            margin-bottom: 15px;
        }

        .gps-data {
            grid-template-columns: 1fr;
        }

        .info-section {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-text {
            color: #1976d2;
            font-size: 14px;
            text-align: center;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .sensor-values {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± ì„¼ì„œ ë°ì´í„° ì „ì†¡</h1>
        
        <div class="info-section">
            <div class="info-text">
                iPhone 15 Pro Maxì˜ ì„¼ì„œ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤
            </div>
        </div>

        <div class="status-section">
            <div class="status-item">
                <span class="status-label">ì„œë²„ ì—°ê²°</span>
                <span class="status-value disconnected" id="connectionStatus">ì—°ê²° ì•ˆë¨</span>
            </div>
            <div class="status-item">
                <span class="status-label">ì„¼ì„œ ìƒíƒœ</span>
                <span class="status-value" id="sensorStatus">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="status-item">
                <span class="status-label">ì „ì†¡ íšŸìˆ˜</span>
                <span class="status-value" id="dataCount">0</span>
            </div>
        </div>

        <div class="permission-section" id="permissionSection">
            <div class="permission-text" id="permissionText">
                ì„¼ì„œ ë°ì´í„° ì ‘ê·¼ì„ ìœ„í•´ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤
            </div>
            <div class="permission-text" style="font-size: 12px; margin-top: 10px; color: #856404;">
                âš ï¸ iOSì—ì„œëŠ” HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ ë³´ì•ˆ ê²½ê³ ê°€ ë‚˜ì˜¤ë©´ "ê³ ê¸‰" â†’ "ì•ˆì „í•˜ì§€ ì•ŠìŒìœ¼ë¡œ ì´ë™"ì„ í´ë¦­í•˜ì„¸ìš”.
            </div>
            <button class="btn btn-primary" id="permissionBtn" onclick="requestPermissions()">ê¶Œí•œ ìš”ì²­</button>
            <button class="btn btn-secondary" id="skipPermissionBtn" onclick="skipPermissions()" style="display: none;">ê¶Œí•œ ì—†ì´ ì‹œì‘</button>
        </div>

        <div class="sensor-data">
            <div class="sensor-title">ğŸ”„ ìì´ë¡œìŠ¤ì½”í”„ (Â°/s)</div>
            <div class="sensor-values">
                <div class="sensor-value">
                    <div class="sensor-value-label">Xì¶•</div>
                    <div class="sensor-value-number" id="gyroX">0.0</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">Yì¶•</div>
                    <div class="sensor-value-number" id="gyroY">0.0</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">Zì¶•</div>
                    <div class="sensor-value-number" id="gyroZ">0.0</div>
                </div>
            </div>
        </div>

        <div class="sensor-data">
            <div class="sensor-title">âš¡ ê°€ì†ë„ê³„ (m/sÂ²)</div>
            <div class="sensor-values">
                <div class="sensor-value">
                    <div class="sensor-value-label">Xì¶•</div>
                    <div class="sensor-value-number" id="accelX">0.0</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">Yì¶•</div>
                    <div class="sensor-value-number" id="accelY">0.0</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">Zì¶•</div>
                    <div class="sensor-value-number" id="accelZ">0.0</div>
                </div>
            </div>
        </div>

        <div class="sensor-data">
            <div class="sensor-title">ğŸ§­ ë°©í–¥ (ë„)</div>
            <div class="sensor-values">
                <div class="sensor-value">
                    <div class="sensor-value-label">Alpha</div>
                    <div class="sensor-value-number" id="orientAlpha">0.0</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">Beta</div>
                    <div class="sensor-value-number" id="orientBeta">0.0</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">Gamma</div>
                    <div class="sensor-value-number" id="orientGamma">0.0</div>
                </div>
            </div>
        </div>

        <div class="sensor-data">
            <div class="sensor-title">ğŸ“ GPS ìœ„ì¹˜</div>
            <div class="sensor-values gps-data">
                <div class="sensor-value">
                    <div class="sensor-value-label">ìœ„ë„</div>
                    <div class="sensor-value-number" id="gpsLat">-</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">ê²½ë„</div>
                    <div class="sensor-value-number" id="gpsLng">-</div>
                </div>
                <div class="sensor-value">
                    <div class="sensor-value-label">ì •í™•ë„</div>
                    <div class="sensor-value-number" id="gpsAccuracy">-</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="startBtn" onclick="startSensors()">ì„¼ì„œ ì‹œì‘</button>
            <button class="btn btn-secondary" id="stopBtn" onclick="stopSensors()" disabled>ì„¼ì„œ ì¤‘ì§€</button>
        </div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;
        let sensorActive = false;
        let dataCount = 0;
        let deviceId = 'iPhone-15-Pro-Max-' + Math.random().toString(36).substr(2, 9);

        // ì„¼ì„œ ë°ì´í„° ì €ì¥ ë³€ìˆ˜
        let sensorData = {
            gyroscope: { x: 0, y: 0, z: 0 },
            accelerometer: { x: 0, y: 0, z: 0 },
            orientation: { alpha: 0, beta: 0, gamma: 0 },
            gps: { latitude: null, longitude: null, accuracy: null }
        };

        // ì—°ê²° ì‹œë„
        function connectToServer() {
            try {
                const serverHost = window.location.hostname || 'localhost';
                let serverPort, protocol;
                
                if (window.location.protocol === 'https:') {
                    serverPort = window.location.port || '8443';
                    protocol = 'wss';
                } else {
                    serverPort = window.location.port || '8080';
                    protocol = 'ws';
                }
                
                socket = new WebSocket(`${protocol}://${serverHost}:${serverPort}`);
                
                socket.onopen = function() {
                    isConnected = true;
                    updateConnectionStatus();
                    
                    // ì¥ì¹˜ ë“±ë¡
                    socket.send(JSON.stringify({
                        type: 'device_register',
                        deviceId: deviceId,
                        deviceType: 'iPhone 15 Pro Max',
                        userAgent: navigator.userAgent,
                        timestamp: Date.now()
                    }));
                };
                
                socket.onclose = function() {
                    isConnected = false;
                    updateConnectionStatus();
                };
                
                socket.onerror = function(error) {
                    console.error('WebSocket ì˜¤ë¥˜:', error);
                    updateConnectionStatus();
                };
                
            } catch (error) {
                console.error('ì—°ê²° ì‹¤íŒ¨:', error);
                updateConnectionStatus();
            }
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.textContent = 'ì—°ê²°ë¨';
                statusElement.className = 'status-value connected';
            } else {
                statusElement.textContent = 'ì—°ê²° ì•ˆë¨';
                statusElement.className = 'status-value disconnected';
            }
        }

        // ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜
        async function requestPermissions() {
            try {
                let motionPermissionGranted = false;
                let orientationPermissionGranted = false;
                
                // iOS 13+ DeviceMotionEvent ê¶Œí•œ ìš”ì²­
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    console.log('DeviceMotionEvent.requestPermission ì‚¬ìš© ê°€ëŠ¥');
                    const motionPermission = await DeviceMotionEvent.requestPermission();
                    console.log('ëª¨ì…˜ ê¶Œí•œ ê²°ê³¼:', motionPermission);
                    if (motionPermission === 'granted') {
                        motionPermissionGranted = true;
                    } else {
                        console.log('ëª¨ì…˜ ì„¼ì„œ ê¶Œí•œ ê±°ë¶€ë¨');
                        document.getElementById('skipPermissionBtn').style.display = 'inline-block';
                        document.getElementById('permissionText').innerHTML = 
                            'ëª¨ì…˜ ì„¼ì„œ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê¶Œí•œ ì—†ì´ ì‹œì‘í•˜ê±°ë‚˜ Safari ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    }
                } else {
                    console.log('DeviceMotionEvent.requestPermission ì‚¬ìš© ë¶ˆê°€ëŠ¥');
                    motionPermissionGranted = true; // ì˜¤ë˜ëœ iOS ë²„ì „ì—ì„œëŠ” ê¶Œí•œ ë¶ˆí•„ìš”
                }

                // iOS 13+ DeviceOrientationEvent ê¶Œí•œ ìš”ì²­
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    console.log('DeviceOrientationEvent.requestPermission ì‚¬ìš© ê°€ëŠ¥');
                    const orientationPermission = await DeviceOrientationEvent.requestPermission();
                    console.log('ë°©í–¥ ê¶Œí•œ ê²°ê³¼:', orientationPermission);
                    if (orientationPermission === 'granted') {
                        orientationPermissionGranted = true;
                    } else {
                        console.log('ë°©í–¥ ì„¼ì„œ ê¶Œí•œ ê±°ë¶€ë¨');
                        document.getElementById('skipPermissionBtn').style.display = 'inline-block';
                        document.getElementById('permissionText').innerHTML = 
                            'ë°©í–¥ ì„¼ì„œ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê¶Œí•œ ì—†ì´ ì‹œì‘í•˜ê±°ë‚˜ Safari ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    }
                } else {
                    console.log('DeviceOrientationEvent.requestPermission ì‚¬ìš© ë¶ˆê°€ëŠ¥');
                    orientationPermissionGranted = true; // ì˜¤ë˜ëœ iOS ë²„ì „ì—ì„œëŠ” ê¶Œí•œ ë¶ˆí•„ìš”
                }

                // GPS ê¶Œí•œ ìš”ì²­
                if ("geolocation" in navigator) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            });
                        });
                        console.log('GPS ê¶Œí•œ í—ˆìš©ë¨');
                        
                        if (motionPermissionGranted && orientationPermissionGranted) {
                            document.getElementById('permissionSection').style.display = 'none';
                            setupSensors();
                        }
                    } catch (error) {
                        console.error('GPS ê¶Œí•œ ì˜¤ë¥˜:', error);
                        document.getElementById('skipPermissionBtn').style.display = 'inline-block';
                        document.getElementById('permissionText').innerHTML = 
                            'GPS ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê¶Œí•œ ì—†ì´ ì‹œì‘í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    }
                } else {
                    console.log('Geolocation ì‚¬ìš© ë¶ˆê°€ëŠ¥');
                    if (motionPermissionGranted && orientationPermissionGranted) {
                        document.getElementById('permissionSection').style.display = 'none';
                        setupSensors();
                    }
                }

            } catch (error) {
                console.error('ê¶Œí•œ ìš”ì²­ ì˜¤ë¥˜:', error);
                document.getElementById('skipPermissionBtn').style.display = 'inline-block';
                document.getElementById('permissionText').innerHTML = 
                    'ê¶Œí•œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ' + error.message + '<br>ê¶Œí•œ ì—†ì´ ì‹œì‘í•´ë³´ì„¸ìš”.';
            }
        }

        function setupSensors() {
            // ìì´ë¡œìŠ¤ì½”í”„ ë° ê°€ì†ë„ê³„ ì„¤ì •
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleMotion, false);
            }

            // ë°©í–¥ ì„¼ì„œ ì„¤ì •
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation, false);
            }

            // GPS ìœ„ì¹˜ ì¶”ì  ì„¤ì •
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    handleGPS,
                    function(error) {
                        console.error('GPS ì˜¤ë¥˜:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }

            document.getElementById('sensorStatus').textContent = 'ì¤€ë¹„ë¨';
            document.getElementById('sensorStatus').className = 'status-value connected';
        }

        function handleMotion(event) {
            if (!sensorActive) return;

            const acceleration = event.accelerationIncludingGravity;
            const rotationRate = event.rotationRate;

            if (acceleration) {
                sensorData.accelerometer = {
                    x: acceleration.x || 0,
                    y: acceleration.y || 0,
                    z: acceleration.z || 0
                };
                
                document.getElementById('accelX').textContent = acceleration.x?.toFixed(2) || '0.0';
                document.getElementById('accelY').textContent = acceleration.y?.toFixed(2) || '0.0';
                document.getElementById('accelZ').textContent = acceleration.z?.toFixed(2) || '0.0';
            }

            if (rotationRate) {
                sensorData.gyroscope = {
                    x: rotationRate.alpha || 0,
                    y: rotationRate.beta || 0,
                    z: rotationRate.gamma || 0
                };
                
                document.getElementById('gyroX').textContent = rotationRate.alpha?.toFixed(2) || '0.0';
                document.getElementById('gyroY').textContent = rotationRate.beta?.toFixed(2) || '0.0';
                document.getElementById('gyroZ').textContent = rotationRate.gamma?.toFixed(2) || '0.0';
            }
        }

        function handleOrientation(event) {
            if (!sensorActive) return;

            sensorData.orientation = {
                alpha: event.alpha || 0,
                beta: event.beta || 0,
                gamma: event.gamma || 0
            };
            
            document.getElementById('orientAlpha').textContent = event.alpha?.toFixed(1) || '0.0';
            document.getElementById('orientBeta').textContent = event.beta?.toFixed(1) || '0.0';
            document.getElementById('orientGamma').textContent = event.gamma?.toFixed(1) || '0.0';
        }

        function handleGPS(position) {
            sensorData.gps = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            document.getElementById('gpsLat').textContent = position.coords.latitude.toFixed(6);
            document.getElementById('gpsLng').textContent = position.coords.longitude.toFixed(6);
            document.getElementById('gpsAccuracy').textContent = position.coords.accuracy.toFixed(1) + 'm';
        }

        function startSensors() {
            if (!isConnected) {
                alert('ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            sensorActive = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('sensorStatus').textContent = 'ì „ì†¡ ì¤‘';
            document.getElementById('sensorStatus').className = 'status-value connected';

            // ì„¼ì„œ ë°ì´í„° ì „ì†¡ ì‹œì‘ (10Hz)
            setInterval(sendSensorData, 100);
        }

        function stopSensors() {
            sensorActive = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('sensorStatus').textContent = 'ì¤‘ì§€ë¨';
            document.getElementById('sensorStatus').className = 'status-value';
        }

        function sendSensorData() {
            if (!sensorActive || !isConnected) return;

            const data = {
                type: 'sensor_data',
                deviceId: deviceId,
                timestamp: Date.now(),
                data: sensorData
            };

            socket.send(JSON.stringify(data));
            dataCount++;
            document.getElementById('dataCount').textContent = dataCount;
        }

        function skipPermissions() {
            console.log('ê¶Œí•œ ì—†ì´ ì„¼ì„œ ì‹œì‘ ì‹œë„');
            document.getElementById('permissionSection').style.display = 'none';
            setupSensors();
        }

        function checkSecureContext() {
            if (!window.isSecureContext) {
                document.getElementById('permissionText').innerHTML = 
                    'âš ï¸ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ê°€ ì•„ë‹™ë‹ˆë‹¤. iOS ì„¼ì„œ ê¶Œí•œì„ ìœ„í•´ HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>' +
                    'ë‹¤ìŒ URLë¡œ ì ‘ì†í•´ë³´ì„¸ìš”: <strong>https://' + window.location.hostname + ':8443' + window.location.pathname + '</strong>';
                return false;
            }
            return true;
        }

        function detectDeviceType() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isAndroid = /Android/.test(userAgent);
            
            console.log('ì‚¬ìš©ì ì—ì´ì „íŠ¸:', userAgent);
            console.log('iOS ê¸°ê¸°:', isIOS);
            console.log('ì•ˆë“œë¡œì´ë“œ ê¸°ê¸°:', isAndroid);
            console.log('ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸:', window.isSecureContext);
            
            return { isIOS, isAndroid };
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° ì‹œë„
        window.onload = function() {
            connectToServer();
            
            const deviceInfo = detectDeviceType();
            
            if (deviceInfo.isIOS && !window.isSecureContext) {
                checkSecureContext();
            } else if (!deviceInfo.isIOS) {
                // iOSê°€ ì•„ë‹Œ ê²½ìš° ê¶Œí•œ ì—†ì´ ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('skipPermissionBtn').style.display = 'inline-block';
            }
        };

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
        window.onbeforeunload = function() {
            if (socket) {
                socket.close();
            }
        };
    </script>
</body>
</html>